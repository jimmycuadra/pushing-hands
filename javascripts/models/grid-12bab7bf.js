(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};ph.Grid=function(t){function r(){return this.clear=e(this.clear,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.prototype.initialize=function(e,t){var n;return this.rowCount=t.rowCount,this.columnCount=t.columnCount,n=t.app,this.sfx=n.sfx,this.store=n.store,this.cellRowsView=new ph.CellRowsView({rows:this.generateRows(),sfx:this.sfx,grid:this}),this.cellRowsView.render()},r.prototype.generateRows=function(){var e,t,n,r,i,s;return s=[],r=function(){var r,o,u;u=[];for(t=r=0,o=this.rowCount;0<=o?r<o:r>o;t=0<=o?++r:--r)e=function(){var e,r,o;o=[];for(n=e=0,r=this.columnCount;0<=r?e<r:e>r;n=0<=r?++e:--e)t>0&&(i=s[n]),o.push(s[n]=new ph.Cell({upperNeighbor:i}));return o}.call(this),u.push(new ph.CellRow(e));return u}.call(this)},r.prototype.markableRows=function(){return this.cellRowsView.rows.slice(0,this.cellRowsView.rows.length-3+1||9e9)},r.prototype.markMatches=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y=this;e==null&&(e=1),l=0,s=[],m=this.markableRows();for(f=h=0,d=m.length;h<d;f=++h){a=m[f],g=a.models;for(r=p=0,v=g.length;p<v;r=++p){t=g[r],c=[t],n=t.get("color"),i=1,u=this.cellRowsView.rows[f+i];if(!u)break;o=u.at(r);while(o.get("color")===n){c.push(o),i++,u=this.cellRowsView.rows[f+i];if(!u)break;o=u.at(r)}c.length>=3&&(s.push.apply(s,c),l+=(3+(c.length-3)*2)*e)}}if(l===0){this.set("locked",!1);return}return this.updateStats(l,e,function(){return y.clear(s,function(){return y.refill(function(){return y.markMatches(e+1)})})})},r.prototype.updateStats=function(e,t,n){return this.store.set("score",this.store.get("score")+e),t>this.store.get("chain")&&this.store.set("chain",t),setTimeout(n,250)},r.prototype.clear=function(e,t){return this.sfx.play("match"),_.each(e,function(e){return e.clear()}),setTimeout(t,250)},r.prototype.refill=function(e){return this.sfx.play("fill"),_.each(this.cellRowsView.rows.slice().reverse(),function(e){return e.refill()}),setTimeout(e,250)},r}(Backbone.Model)}).call(this);